// Schoolaris - Marketplace de Cours Scolaires
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ ENUMS ============

enum Role {
  PARENT
  TEACHER
  ADMIN
}

enum GradeLevel {
  CP
  CE1
  CE2
  CM1
  CM2
  SIXIEME
  CINQUIEME
  QUATRIEME
  TROISIEME
  SECONDE
  PREMIERE
  TERMINALE
}

enum Subject {
  MATHEMATIQUES
  FRANCAIS
  HISTOIRE_GEO
  SCIENCES
  ANGLAIS
  PHYSIQUE_CHIMIE
  SVT
  PHILOSOPHIE
  ESPAGNOL
  ALLEMAND
  SES
  NSI
}

enum ContentType {
  VIDEO
  TEXT
  QUIZ
  EXERCISE
  DOCUMENT
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

// ============ AUTH (NextAuth) ============

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============ USERS ============

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(PARENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts       Account[]
  sessions       Session[]
  children       Child[]          @relation("ParentChildren")
  teacherProfile TeacherProfile?
  courses        Course[]         @relation("CourseAuthor")
  purchases      Purchase[]
  reviews        Review[]
  teacherLiveSessions LiveSession[] @relation("TeacherSessions")
  parentLiveSessions  LiveSession[] @relation("ParentSessions")
  forumTopics    ForumTopic[]     @relation("TopicAuthor")
  forumReplies   ForumReply[]     @relation("ReplyAuthor")
  forumVotes     ForumVote[]      @relation("UserVotes")
  alerts         Alert[]

  @@index([email])
  @@index([role])
}

model Child {
  id         String     @id @default(cuid())
  firstName  String
  lastName   String?
  avatarUrl  String?
  gradeLevel GradeLevel
  parentId   String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Gamification
  xp             Int      @default(0)
  level          Int      @default(1)
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActivityAt DateTime?

  // Relations
  parent           User              @relation("ParentChildren", fields: [parentId], references: [id], onDelete: Cascade)
  purchases        Purchase[]
  progress         Progress[]
  conversations    AIConversation[]
  badges           ChildBadge[]
  weeklyReports    WeeklyReport[]
  exercises        Exercise[]
  exerciseAttempts ExerciseAttempt[]
  certificates     Certificate[]
  liveSessions     LiveSession[]
  forumTopics      ForumTopic[]      @relation("ChildTopics")
  forumReplies     ForumReply[]      @relation("ChildReplies")
  weakAreas        WeakArea[]
  alerts           Alert[]
  quizAttempts     QuizAttempt[]

  @@index([parentId])
  @@index([gradeLevel])
}

model TeacherProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  slug            String    @unique
  headline        String?   // "Professeur de Mathematiques - 15 ans d'experience"
  bio             String?   @db.Text
  avatarUrl       String?
  coverImageUrl   String?
  specialties     Subject[]
  qualifications  String?   @db.Text
  yearsExperience Int?
  isVerified      Boolean   @default(false)

  // Stripe Connect
  stripeAccountId   String?  @unique
  stripeOnboarded   Boolean  @default(false)

  // Stats (denormalized for performance)
  totalStudents     Int      @default(0)
  totalCourses      Int      @default(0)
  totalRevenue      Int      @default(0) // in cents
  averageRating     Float    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([isVerified])
}

// ============ COURSES ============

model Course {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  subtitle    String?     // Short description for cards
  description String?     @db.Text
  imageUrl    String?
  previewVideoUrl String?

  // Classification
  gradeLevel  GradeLevel
  subject     Subject

  // Pricing (marketplace model)
  price       Int         // in cents (e.g., 2990 = 29.90 EUR)

  // Status
  isPublished Boolean     @default(false)
  publishedAt DateTime?

  // Stats (denormalized)
  totalStudents   Int     @default(0)
  totalLessons    Int     @default(0)
  totalDuration   Int     @default(0) // in minutes
  averageRating   Float   @default(0)
  reviewCount     Int     @default(0)

  // What students will learn (JSON array of strings)
  learningOutcomes Json?

  // Requirements (JSON array of strings)
  requirements Json?

  authorId    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  author       User          @relation("CourseAuthor", fields: [authorId], references: [id])
  chapters     Chapter[]
  purchases    Purchase[]
  reviews      Review[]
  certificates Certificate[]

  @@index([slug])
  @@index([gradeLevel])
  @@index([subject])
  @@index([authorId])
  @@index([isPublished])
  @@index([price])
}

model Chapter {
  id          String   @id @default(cuid())
  title       String
  description String?
  position    Int
  courseId    String
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@index([position])
}

model Lesson {
  id          String      @id @default(cuid())
  title       String
  description String?
  content     String?     @db.Text
  contentType ContentType @default(TEXT)
  videoUrl    String?
  duration    Int?        // in minutes
  position    Int
  chapterId   String
  isPublished Boolean     @default(false)
  isFreePreview Boolean   @default(false) // Free preview lesson
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  chapter      Chapter       @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  quizzes      Quiz[]
  progress     Progress[]
  resources    Resource[]
  exercises    Exercise[]
  quizAttempts QuizAttempt[]

  @@index([chapterId])
  @@index([position])
}

model Resource {
  id        String   @id @default(cuid())
  title     String
  type      String   // pdf, doc, link, etc.
  url       String
  lessonId  String
  createdAt DateTime @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

// ============ QUIZZES ============

model Quiz {
  id           String   @id @default(cuid())
  title        String
  description  String?
  lessonId     String
  passingScore Int      @default(70)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  lesson    Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]

  @@index([lessonId])
}

model Question {
  id          String   @id @default(cuid())
  quizId      String
  question    String   @db.Text
  options     Json     // Array of {id, text, isCorrect}
  explanation String?  @db.Text
  points      Int      @default(1)
  position    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([position])
}

// ============ QUIZ ATTEMPTS (History) ============

model QuizAttempt {
  id          String   @id @default(cuid())
  childId     String
  quizId      String
  lessonId    String

  // Results
  score       Int      // Points earned
  totalPoints Int      // Maximum possible points
  percentage  Int      // Percentage score (0-100)
  passed      Boolean  // Did they pass?
  correctCount Int     // Number of correct answers
  totalQuestions Int   // Total questions in quiz

  // Detailed answers (JSON)
  answers     Json     // Array of {questionId, selectedOptionId, isCorrect, timeSpent}

  // Timing
  timeSpent   Int      // Total time in seconds
  startedAt   DateTime // When the attempt started
  completedAt DateTime @default(now()) // When the attempt was submitted

  // AI Feedback
  aiFeedback  String?  @db.Text // AI-generated feedback for this attempt

  createdAt   DateTime @default(now())

  // Relations
  child       Child    @relation(fields: [childId], references: [id], onDelete: Cascade)
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([quizId])
  @@index([lessonId])
  @@index([completedAt])
  @@index([passed])
}

// ============ PURCHASES (Marketplace) ============

model Purchase {
  id                  String         @id @default(cuid())
  userId              String         // Parent who bought
  childId             String?        // Child the course is for (optional)
  courseId            String

  // Pricing at time of purchase
  amount              Int            // Amount paid in cents
  platformFee         Int            // 30% commission in cents
  teacherRevenue      Int            // 70% to teacher in cents

  // Stripe
  stripePaymentIntentId String?      @unique
  stripeTransferId      String?      // Transfer to teacher's Stripe account

  status              PurchaseStatus @default(PENDING)

  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  child  Child? @relation(fields: [childId], references: [id], onDelete: SetNull)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([childId])
  @@index([courseId])
  @@index([status])
}

// ============ PROGRESS ============

model Progress {
  id          String   @id @default(cuid())
  childId     String
  lessonId    String
  isCompleted Boolean  @default(false)
  quizScore   Int?
  timeSpent   Int      @default(0) // in seconds
  lastAccessedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  child  Child  @relation(fields: [childId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([childId, lessonId])
  @@index([childId])
  @@index([lessonId])
}

// ============ REVIEWS ============

model Review {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int      // 1-5
  title     String?
  comment   String?  @db.Text
  isVerified Boolean @default(false) // Verified purchase

  // Helpful votes
  helpfulCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
}

// ============ PARENT ALERTS ============

enum AlertType {
  INACTIVITY       // Child hasn't studied for X days
  LOW_QUIZ_SCORE   // Child scored below threshold on quiz
  MILESTONE        // Child completed chapter/course
  STREAK           // Child maintained streak
  WEEKLY_REPORT    // Weekly progress summary
  AI_INSIGHT       // AI-generated insight about performance
}

enum AlertPriority {
  LOW
  MEDIUM
  HIGH
}

model Alert {
  id          String        @id @default(cuid())
  parentId    String
  childId     String?
  type        AlertType
  priority    AlertPriority @default(MEDIUM)
  title       String
  message     String        @db.Text
  metadata    Json?         // Additional context (courseId, quizScore, etc.)
  isRead      Boolean       @default(false)
  isDismissed Boolean       @default(false)
  emailSent   Boolean       @default(false) // Track if email notification was sent
  actionUrl   String?       // Deep link to relevant page
  expiresAt   DateTime?     // Auto-dismiss after this date
  createdAt   DateTime      @default(now())

  parent      User          @relation(fields: [parentId], references: [id], onDelete: Cascade)
  child       Child?        @relation(fields: [childId], references: [id], onDelete: SetNull)

  @@index([parentId])
  @@index([childId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@index([emailSent])
}

// ============ AI TUTOR ============

enum AIMessageRole {
  USER
  ASSISTANT
}

model AIConversation {
  id        String   @id @default(cuid())
  childId   String
  courseId  String?  // Optional: conversation can be course-specific
  lessonId  String?  // Optional: conversation can be lesson-specific
  title     String?  // Auto-generated from first message
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  child    Child        @relation(fields: [childId], references: [id], onDelete: Cascade)
  messages AIMessage[]

  @@index([childId])
  @@index([courseId])
  @@index([lessonId])
  @@index([createdAt])
}

model AIMessage {
  id             String        @id @default(cuid())
  conversationId String
  role           AIMessageRole
  content        String        @db.Text

  // Context at time of message (for AI to understand)
  contextCourseId  String?
  contextLessonId  String?
  contextQuizScore Int?

  // Metadata
  tokensUsed     Int?          // Track API usage for cost management
  createdAt      DateTime      @default(now())

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
}

// ============ GAMIFICATION ============

enum BadgeCategory {
  PROGRESS     // Completing lessons/courses
  STREAK       // Daily study streaks
  QUIZ         // Quiz performance
  ACHIEVEMENT  // Special milestones
  SOCIAL       // Sharing, helping others
}

model Badge {
  id          String        @id @default(cuid())
  code        String        @unique // e.g., "first_lesson", "streak_7", "quiz_master"
  name        String
  description String
  imageUrl    String?
  category    BadgeCategory
  xpReward    Int           @default(0)
  requirement Json?         // e.g., { "lessonsCompleted": 10 }
  isSecret    Boolean       @default(false)
  createdAt   DateTime      @default(now())

  children ChildBadge[]

  @@index([category])
  @@index([code])
}

model ChildBadge {
  id        String   @id @default(cuid())
  childId   String
  badgeId   String
  earnedAt  DateTime @default(now())

  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([childId, badgeId])
  @@index([childId])
  @@index([badgeId])
  @@index([earnedAt])
}

// ============ GENERATIVE EXERCISES ============

enum ExerciseType {
  FILL_IN_BLANK    // Texte a trous
  MATCHING         // Appariement (relier les elements)
  ORDERING         // Remettre dans l'ordre
  SHORT_ANSWER     // Reponse courte
  TRUE_FALSE       // Vrai ou Faux
  CALCULATION      // Calcul mathematique
}

model Exercise {
  id          String       @id @default(cuid())
  lessonId    String
  childId     String
  type        ExerciseType
  difficulty  String       @default("medium") // easy, medium, hard

  // Exercise content (JSON)
  content     Json         // {question, instructions, items, blanks, etc.}
  solution    Json         // {correctAnswer, steps, etc.}

  // AI generation metadata
  generatedAt DateTime     @default(now())
  aiModel     String?      // Which AI model generated this

  // Relations
  lesson   Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  child    Child            @relation(fields: [childId], references: [id], onDelete: Cascade)
  attempts ExerciseAttempt[]

  @@index([lessonId])
  @@index([childId])
  @@index([type])
  @@index([difficulty])
  @@index([generatedAt])
}

model ExerciseAttempt {
  id          String   @id @default(cuid())
  exerciseId  String
  childId     String

  // Attempt data
  answer      Json     // The child's submitted answer
  isCorrect   Boolean
  score       Int      @default(0) // Points earned
  feedback    String?  @db.Text // AI-generated feedback
  timeSpent   Int      @default(0) // in seconds

  // XP awarded
  xpEarned    Int      @default(0)

  createdAt   DateTime @default(now())

  // Relations
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  child    Child    @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
  @@index([childId])
  @@index([createdAt])
}

// ============ CERTIFICATES ============

model Certificate {
  id           String   @id @default(cuid())
  childId      String
  courseId     String

  // Certificate details
  certificateNumber String  @unique // Format: SCH-2024-XXXXXX
  childName    String          // Snapshot at time of completion
  courseName   String          // Snapshot at time of completion
  teacherName  String          // Snapshot at time of completion
  gradeLevel   GradeLevel
  subject      Subject

  // Completion stats
  completionDate DateTime
  totalLessons   Int
  lessonsCompleted Int
  averageQuizScore Float?
  totalTimeSpent   Int         // in minutes

  // Verification
  verificationCode String @unique // Unique code for verification
  verificationUrl  String?        // Public URL to verify certificate

  // PDF Storage
  pdfUrl       String?           // URL to generated PDF

  createdAt    DateTime @default(now())

  // Relations
  child  Child  @relation(fields: [childId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([childId, courseId])
  @@index([childId])
  @@index([courseId])
  @@index([certificateNumber])
  @@index([verificationCode])
}

// ============ LIVE SESSIONS ============

enum LiveSessionStatus {
  SCHEDULED      // Session is booked
  IN_PROGRESS    // Session is currently happening
  COMPLETED      // Session has ended
  CANCELLED      // Session was cancelled
  NO_SHOW        // Student/parent didn't show up
}

model TeacherAvailability {
  id           String   @id @default(cuid())
  teacherId    String   // User ID of the teacher
  dayOfWeek    Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime    String   // "09:00" format (24h)
  endTime      String   // "17:00" format (24h)
  isActive     Boolean  @default(true)
  timezone     String   @default("Europe/Paris")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([teacherId, dayOfWeek, startTime])
  @@index([teacherId])
  @@index([dayOfWeek])
  @@index([isActive])
}

model LiveSession {
  id               String            @id @default(cuid())
  teacherId        String            // User ID of the teacher
  parentId         String            // User ID of the parent who booked
  childId          String            // Child who will attend
  subject          Subject
  gradeLevel       GradeLevel

  // Session details
  title            String            // e.g., "Aide en Mathematiques - Fractions"
  description      String?           @db.Text
  scheduledAt      DateTime          // When the session is scheduled
  duration         Int               @default(60) // Duration in minutes
  status           LiveSessionStatus @default(SCHEDULED)

  // Video room
  roomUrl          String?           // Video room URL (Daily.co, etc.)
  roomName         String?           @unique // Unique room identifier

  // Pricing
  price            Int               // Price in cents
  platformFee      Int               // 30% commission in cents
  teacherRevenue   Int               // 70% to teacher in cents

  // Stripe
  stripePaymentIntentId String?      @unique
  stripeTransferId      String?

  // Session notes (filled after session)
  teacherNotes     String?           @db.Text // Teacher's notes about the session
  parentFeedback   String?           @db.Text // Parent's feedback
  rating           Int?              // 1-5 star rating from parent

  // Timing
  startedAt        DateTime?
  endedAt          DateTime?
  cancelledAt      DateTime?
  cancellationReason String?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  teacher          User              @relation("TeacherSessions", fields: [teacherId], references: [id])
  parent           User              @relation("ParentSessions", fields: [parentId], references: [id])
  child            Child             @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([parentId])
  @@index([childId])
  @@index([scheduledAt])
  @@index([status])
  @@index([subject])
}

// ============ WEAK AREAS TRACKING ============

// Tracks specific areas where a child struggles (e.g., "fractions", "conjugaison")
model WeakArea {
  id            String     @id @default(cuid())
  childId       String
  subject       Subject
  topic         String     // e.g., "fractions", "conjugaison imparfait", "theoreme Pythagore"
  gradeLevel    GradeLevel

  // Tracking metrics
  errorCount    Int        @default(1)    // Number of times this area was missed
  attemptCount  Int        @default(1)    // Total attempts on this topic
  lastErrorAt   DateTime   @default(now())
  firstSeenAt   DateTime   @default(now())

  // AI categorization
  category      String?    // e.g., "calcul", "comprehension", "methode"
  difficulty    String?    // Perceived difficulty: easy, medium, hard

  // Progress tracking
  isResolved    Boolean    @default(false) // Marked as mastered
  resolvedAt    DateTime?

  // Relations
  child         Child      @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, subject, topic])
  @@index([childId])
  @@index([subject])
  @@index([gradeLevel])
  @@index([isResolved])
  @@index([errorCount])
  @@index([lastErrorAt])
}

// ============ WEEKLY REPORTS ============

model WeeklyReport {
  id           String   @id @default(cuid())
  childId      String
  weekStart    DateTime // Monday of the report week
  weekEnd      DateTime // Sunday of the report week

  // Stats for the week
  lessonsCompleted   Int      @default(0)
  quizzesCompleted   Int      @default(0)
  averageQuizScore   Float?
  totalTimeSpent     Int      @default(0) // in minutes
  xpEarned           Int      @default(0)
  streakDays         Int      @default(0)

  // Comparison with previous week
  lessonsCompletedDelta Int?   // +/- compared to last week
  timeSpentDelta        Int?   // +/- compared to last week

  // AI-generated content
  summary        String?  @db.Text   // AI summary of the week
  strengths      Json?               // Array of strengths identified
  areasToImprove Json?               // Array of areas needing attention
  recommendations Json?              // Array of personalized recommendations
  encouragement  String?  @db.Text   // Motivational message for the child
  parentTips     String?  @db.Text   // Tips for the parent

  // Notification tracking
  emailSent      Boolean  @default(false)
  sentAt         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  child Child @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([childId, weekStart])
  @@index([childId])
  @@index([weekStart])
  @@index([createdAt])
}

// ============ COMMUNITY FORUMS ============

enum ForumCategory {
  GENERAL           // Questions generales
  HOMEWORK_HELP     // Aide aux devoirs
  STUDY_TIPS        // Conseils d'etude
  EXAM_PREP         // Preparation examens
  PARENT_CORNER     // Espace parents
  TEACHER_LOUNGE    // Espace enseignants
  ANNOUNCEMENTS     // Annonces officielles
}

model ForumTopic {
  id          String         @id @default(cuid())
  title       String
  content     String         @db.Text
  category    ForumCategory
  subject     Subject?       // Optional: topic can be subject-specific
  gradeLevel  GradeLevel?    // Optional: topic can be grade-specific

  // Author (can be parent, teacher, or child via parent)
  authorId    String         // User ID
  authorType  Role           // PARENT, TEACHER, or ADMIN
  childId     String?        // If posted on behalf of a child

  // Status
  isPinned    Boolean        @default(false)
  isLocked    Boolean        @default(false)  // Prevent new replies
  isResolved  Boolean        @default(false)  // For help requests

  // Stats (denormalized)
  replyCount  Int            @default(0)
  viewCount   Int            @default(0)
  lastReplyAt DateTime?
  lastReplyBy String?        // User ID of last replier

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  author      User           @relation("TopicAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  child       Child?         @relation("ChildTopics", fields: [childId], references: [id], onDelete: SetNull)
  replies     ForumReply[]
  votes       ForumVote[]    @relation("TopicVotes")

  @@index([category])
  @@index([subject])
  @@index([gradeLevel])
  @@index([authorId])
  @@index([isPinned])
  @@index([isLocked])
  @@index([createdAt])
  @@index([lastReplyAt])
}

model ForumReply {
  id          String         @id @default(cuid())
  topicId     String
  content     String         @db.Text

  // Author
  authorId    String         // User ID
  authorType  Role           // PARENT, TEACHER, or ADMIN
  childId     String?        // If posted on behalf of a child

  // Parent reply for threading
  parentReplyId String?

  // Status
  isAccepted  Boolean        @default(false)  // Marked as best answer
  isHidden    Boolean        @default(false)  // Hidden by moderator

  // Stats
  voteScore   Int            @default(0)      // Upvotes - downvotes

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  topic       ForumTopic     @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author      User           @relation("ReplyAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  child       Child?         @relation("ChildReplies", fields: [childId], references: [id], onDelete: SetNull)
  parentReply ForumReply?    @relation("ReplyThread", fields: [parentReplyId], references: [id], onDelete: SetNull)
  childReplies ForumReply[]  @relation("ReplyThread")
  votes       ForumVote[]    @relation("ReplyVotes")

  @@index([topicId])
  @@index([authorId])
  @@index([parentReplyId])
  @@index([isAccepted])
  @@index([createdAt])
}

model ForumVote {
  id          String         @id @default(cuid())
  userId      String
  topicId     String?
  replyId     String?
  value       Int            // 1 for upvote, -1 for downvote
  createdAt   DateTime       @default(now())

  // Relations
  user        User           @relation("UserVotes", fields: [userId], references: [id], onDelete: Cascade)
  topic       ForumTopic?    @relation("TopicVotes", fields: [topicId], references: [id], onDelete: Cascade)
  reply       ForumReply?    @relation("ReplyVotes", fields: [replyId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@unique([userId, replyId])
  @@index([userId])
  @@index([topicId])
  @@index([replyId])
}
